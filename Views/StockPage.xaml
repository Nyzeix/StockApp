<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="StockApp.Views.StockPage"
             xmlns:models="clr-namespace:StockApp.Models"
             Title="ðŸ“¦ Gestion du stock"
             BackgroundColor="{AppThemeBinding Light={DynamicResource LightBackgroundColor}, Dark={DynamicResource DarkBackgroundColor}}">

    <!-- Utiliser un Grid / VerticalStackLayout pour laisser CollectionView faire le scroll -->
    <Grid Padding="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header : boutons / recherche / filtres, reste en haut -->
        <VerticalStackLayout Grid.Row="0" Spacing="15">
            <Button Text="âž• Ajouter un produit"
                    x:Name="AddButton"
                    FontAttributes="Bold"
                    CornerRadius="10"
                    HeightRequest="50"
                    BackgroundColor="{AppThemeBinding Light={DynamicResource LightPrimaryButtonColor}, Dark={DynamicResource DarkPrimaryButtonColor}}"
                    TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                    Clicked="OnAddButtonClicked" />

            <SearchBar x:Name="ProductSearchBar"
                       Placeholder="Rechercher un produit..."
                       FontSize="16"
                       HeightRequest="50"
                       TextChanged="OnSearchBarTextChanged"
                       Margin="0,5,0,0"
                       BackgroundColor="{AppThemeBinding Light={DynamicResource LightBlockBackgroundColor}, Dark={DynamicResource DarkBlockBackgroundColor}}"
                       TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                       PlaceholderColor="{AppThemeBinding Light={DynamicResource LightPrimaryColor}, Dark={DynamicResource DarkPrimaryColor}}"/>

            <!-- Ligne des filtres -->
            <HorizontalStackLayout Spacing="10" HorizontalOptions="FillAndExpand">
                    <Picker x:Name="QuantityPicker"
                            Title="QuantitÃ©"
                            FontSize="16"
                            HorizontalOptions="FillAndExpand"
                            BackgroundColor="{AppThemeBinding Light={DynamicResource LightBlockBackgroundColor}, Dark={DynamicResource DarkBlockBackgroundColor}}"
                            TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                            HeightRequest="65"
                            ItemsSource="{Binding Quantity}"
                            SelectedIndexChanged="QuantityPicker_SelectedIndexChanged"/>

                    <Picker x:Name="OriginPicker"
                        Title="Origine"
                        FontSize="16"
                        HorizontalOptions="FillAndExpand"
                        BackgroundColor="{AppThemeBinding Light={DynamicResource LightBlockBackgroundColor}, Dark={DynamicResource DarkBlockBackgroundColor}}"
                        TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                        HeightRequest="65"  
                        ItemsSource="{Binding Origins}"
                        SelectedIndexChanged="OriginPicker_SelectedIndexChanged" />
            </HorizontalStackLayout>

            <!-- Formulaire dâ€™ajout -->
            <Border x:Name="AddProductForm"
                   IsVisible="False"
                   BackgroundColor="{AppThemeBinding Light={DynamicResource LightBackgroundColor}, Dark={DynamicResource DarkBackgroundColor}}"
                   Padding="15"
                   Margin="0,10,0,10">

                <VerticalStackLayout Spacing="10">
                    <Label Text="Ajouter un produit"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                           HorizontalOptions="Center" />

                    <!-- Nom -->
                    <Border Padding="10" 
                            BackgroundColor="{AppThemeBinding Light={DynamicResource LightBlockgroundColor}, Dark={DynamicResource DarkBlockBackgroundColor}}"
                            Stroke="{AppThemeBinding Light={DynamicResource LightSecondaryColor}, Dark={DynamicResource DarkSecondaryColor}}">
                        <Entry x:Name="NameEntry"
                               Placeholder="Nom du produit"
                               BackgroundColor="Transparent"
                               TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                               PlaceholderColor="{AppThemeBinding Light={DynamicResource LightPrimaryColor}, Dark={DynamicResource DarkPrimaryColor}}"/>
                    </Border>

                        <Picker
                            x:Name="SupplierPicker"
                            Title="Fournisseur"
                            FontSize="16"
                            HorizontalOptions="FillAndExpand"
                            BackgroundColor="{AppThemeBinding Light={DynamicResource LightBlockBackgroundColor}, Dark={DynamicResource DarkBlockBackgroundColor}}"
                            TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                            HeightRequest="65"/>

                        <!-- QuantitÃ© -->
                    <Border Padding="10"
                            BackgroundColor="{AppThemeBinding Light={DynamicResource LightBlockgroundColor}, Dark={DynamicResource DarkBlockBackgroundColor}}"
                            Stroke="{AppThemeBinding Light={DynamicResource LightSecondaryColor}, Dark={DynamicResource DarkSecondaryColor}}">
                        <Entry x:Name="QuantityEntry"
                               Placeholder="QuantitÃ©"
                               Keyboard="Numeric"
                               BackgroundColor="Transparent"
                               TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                               PlaceholderColor="{AppThemeBinding Light={DynamicResource LightPrimaryColor}, Dark={DynamicResource DarkPrimaryColor}}" />
                    </Border>

                    <!-- Couleur -->
                    <Border Padding="10" 
                            BackgroundColor="{AppThemeBinding Light={DynamicResource LightBlockBackgroundColor}, Dark={DynamicResource DarkBlockBackgroundColor}}"
                            Stroke="{AppThemeBinding Light={DynamicResource LightSecondaryColor}, Dark={DynamicResource DarkSecondaryColor}}">
                        <Entry x:Name="ColorEntry"
                               Placeholder="Couleur"
                               BackgroundColor="Transparent"
                               TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                               PlaceholderColor="{AppThemeBinding Light={DynamicResource LightPrimaryColor}, Dark={DynamicResource DarkPrimaryColor}}" />
                    </Border>

                    <!-- Origine -->
                    <Border Padding="10"
                            BackgroundColor="{AppThemeBinding Light={DynamicResource LightBlockBackgroundColor}, Dark={DynamicResource DarkBlockBackgroundColor}}"
                            Stroke="{AppThemeBinding Light={DynamicResource LightSecondaryColor}, Dark={DynamicResource DarkSecondaryColor}}">
                        <Entry x:Name="OriginEntry"
                               Placeholder="Origine"
                               BackgroundColor="Transparent"
                               TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                               PlaceholderColor="{AppThemeBinding Light={DynamicResource LightPrimaryColor}, Dark={DynamicResource DarkPrimaryColor}}"/>
                    </Border>

                    <!-- Date de pÃ©remption -->
                        <Label Text="Date de pÃ©remption :"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"/>
                        <DatePicker x:Name="ExpirationDatePicker"
                                    TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                                    BackgroundColor="{AppThemeBinding Light={DynamicResource DarkTextColor}, Dark={DynamicResource LightTextColor}}" />

                            <HorizontalStackLayout HorizontalOptions="Center" Spacing="15">
                        <Button Text="ðŸ’¾ Enregistrer"
                                x:Name="SaveButton"
                                TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                                BackgroundColor="{AppThemeBinding Light={DynamicResource LightPrimaryButtonColor}, Dark={DynamicResource DarkPrimaryButtonColor}}"
                                FontAttributes="Bold"
                                CornerRadius="10"
                                HeightRequest="45"
                                Clicked="OnSaveProductClicked" />
                        <Button Text="âŒ Annuler"
                                x:Name="CancelButton"
                                TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                                BackgroundColor="{AppThemeBinding Light={DynamicResource LightSecondaryButtonColor}, Dark={DynamicResource DarkSecondaryButtonColor}}"
                                FontAttributes="Bold"
                                CornerRadius="10"
                                HeightRequest="45"
                                Clicked="OnCancelClicked" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Border>
        </VerticalStackLayout>

        <!-- CollectionView : laisse le scrolling et la virtualisation fonctionner correctement -->
        <CollectionView x:Name="StockCollectionView"
                        Grid.Row="1"
                        ItemsSource="{Binding StockItems}"
                        Margin="0,10,0,0"
                        SelectionMode="Single"
                        SelectionChanged="OnItemSelected"
                        VerticalOptions="FillAndExpand"
                        ItemSizingStrategy="MeasureFirstItem"
                        RemainingItemsThreshold="5"
                        RemainingItemsThresholdReached="OnRemainingItemsThresholdReached">

            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="10" />
            </CollectionView.ItemsLayout>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Product">
                    <Border BackgroundColor="{AppThemeBinding Light={DynamicResource LightAccentColor}, Dark={DynamicResource DarkAccentColor}}"
                            Padding="15">

                        <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto">

                            <Label Grid.Row="0" Grid.Column="0"
                                   Text="{Binding Name}"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={DynamicResource BlackBrush}, Dark={DynamicResource WhiteBrush}}"/>

                            <Label Grid.Row="0" Grid.Column="1"
                                   Text="{Binding Origin, StringFormat='Origine : {0}'}"
                                   FontSize="16"
                                   HorizontalTextAlignment="End"
                                   TextColor="#555" />

                            <Label Grid.Row="1" Grid.Column="0"
                                   Text="{Binding Quantity, StringFormat='QuantitÃ© : {0}'}"
                                   FontSize="16"
                                   TextColor="#0078D7" />

                            <Label Grid.Row="1" Grid.Column="1"
                                   Text="{Binding ExpirationDate, StringFormat='PÃ©remption : {0:dd/MM/yyyy}'}"
                                   FontSize="14"
                                   HorizontalTextAlignment="End"
                                   TextColor="#D9534F" />

                            <Label Grid.Row="2" Grid.Column="1"
                                   Text="{Binding Color, StringFormat='Couleur : {0}'}"
                                   FontSize="14"
                                   HorizontalOptions="End"
                                   TextColor="#666" />

                            <Label Grid.Row="2" Grid.Column="0"
                                   Text="{Binding Supplier, StringFormat='Fournisseur : {0}'}"
                                   FontSize="14"
                                   TextColor="#666" />

                            <Button Grid.Row="0" Grid.Column="2"
                                    Text="âŒ Supprimer"
                                    BackgroundColor="{AppThemeBinding Light={DynamicResource LightBlockBackgroundColor}, Dark={DynamicResource DarkBlockBackgroundColor}}"
                                    TextColor="{AppThemeBinding Light={DynamicResource LightTextColor}, Dark={DynamicResource DarkTextColor}}"
                                    FontAttributes="Bold"
                                    CornerRadius="8"
                                    HeightRequest="40"
                                    Clicked="OnDeleteProductClicked"
                                    VerticalOptions="Center"/>
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>
